<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Onboarding API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>Debug Onboarding API Issues</h1>
    <p>This page helps debug the onboarding popup API issues.</p>

    <div class="test-section">
        <h3>Test Configuration</h3>
        <label>Backend URL: 
            <input type="text" id="backendUrl" value="https://prodigyhub.onrender.com" style="width: 300px;">
        </label><br>
        <label>User UID: 
            <input type="text" id="userUid" value="test_user_123" placeholder="Enter user UID">
        </label><br>
        <label>Email: 
            <input type="text" id="userEmail" value="test@example.com" placeholder="Enter email">
        </label>
    </div>

    <div class="test-section">
        <h3>API Tests</h3>
        <button onclick="testUserProfileSave()">Test Save User Profile</button>
        <button onclick="testQualificationAPI()">Test Qualification API</button>
        <button onclick="testUserProfileGet()">Test Get User Profile</button>
        <button onclick="clearResults()">Clear Results</button>
        <div id="test-results"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            resultsDiv.innerHTML += `<div class="test-section ${className}">[${timestamp}] ${message}</div>`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
        }

        async function testUserProfileSave() {
            const backendURL = document.getElementById('backendUrl').value;
            const userUid = document.getElementById('userUid').value;
            const userEmail = document.getElementById('userEmail').value;
            
            log('üîÑ Testing user profile save...');
            
            const testUserData = {
                uid: userUid,
                email: userEmail,
                firstName: 'Test',
                lastName: 'User',
                phoneNumber: '+94771234567',
                nic: '123456789V',
                address: {
                    street: '123 Test Street',
                    city: 'Colombo',
                    district: 'Colombo',
                    province: 'Western',
                    postalCode: '10100'
                },
                authMethod: 'email',
                onboardingCompleted: true
            };

            try {
                log(`üìù Saving to: ${backendURL}/users/profile`);
                log(`üìù Payload: <pre>${JSON.stringify(testUserData, null, 2)}</pre>`);

                const response = await fetch(`${backendURL}/users/profile`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testUserData)
                });

                log(`üìä Response status: ${response.status}`);
                log(`üìä Response headers: <pre>${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}</pre>`);

                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Save successful: <pre>${JSON.stringify(data, null, 2)}</pre>`, 'success');
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Save failed: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Save error: ${error.message}`, 'error');
            }
        }

        async function testUserProfileGet() {
            const backendURL = document.getElementById('backendUrl').value;
            const userUid = document.getElementById('userUid').value;
            
            log('üîÑ Testing user profile get...');
            
            try {
                const response = await fetch(`${backendURL}/users/profile/${userUid}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                log(`üìä Get response status: ${response.status}`);

                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Get successful: <pre>${JSON.stringify(data, null, 2)}</pre>`, 'success');
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Get failed: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Get error: ${error.message}`, 'error');
            }
        }

        async function testQualificationAPI() {
            log('üîÑ Testing qualification API...');
            
            const qualificationData = {
                instantSync: true,
                provideAlternative: true,
                provideOnlyAvailable: true,
                provideUnavailabilityReason: true,
                
                location: {
                    address: "123 Test St, Colombo",
                    district: "Colombo",
                    province: "Western",
                    postalCode: "10100",
                    coordinates: { lat: 0, lng: 0 }
                },
                
                requestedServices: ['Broadband', 'Fiber'],
                checkFiber: true,
                checkADSL: true,
                checkMobile: true,
                customerType: 'residential',
                
                productOfferingQualificationItem: [{
                    productOffering: {
                        id: 'slt-test-check',
                        name: 'Test Infrastructure Check',
                        '@type': 'ProductOffering'
                    },
                    qualificationItem: {
                        location: {
                            address: "123 Test St, Colombo",
                            district: "Colombo",
                            province: "Western",
                            postalCode: "10100"
                        },
                        requestedServices: ['Broadband', 'Fiber'],
                        checkFiber: true,
                        checkADSL: true,
                        checkMobile: true,
                        customerType: 'residential'
                    },
                    '@type': 'ProductOfferingQualificationItem'
                }],
                
                '@type': 'CheckProductOfferingQualification'
            };

            try {
                log(`üìù Qualification payload: <pre>${JSON.stringify(qualificationData, null, 2)}</pre>`);

                const response = await fetch('/api/productOfferingQualification/v5/checkProductOfferingQualification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify(qualificationData)
                });

                log(`üìä Qualification response status: ${response.status}`);

                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Qualification successful: <pre>${JSON.stringify(data, null, 2)}</pre>`, 'success');
                } else {
                    const errorText = await response.text();
                    log(`‚ùå Qualification failed: ${errorText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Qualification error: ${error.message}`, 'error');
            }
        }

        // Auto-run basic tests on page load
        window.onload = function() {
            log('üöÄ Page loaded, ready for testing...');
        };
    </script>
</body>
</html>

